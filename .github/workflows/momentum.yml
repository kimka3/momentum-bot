name: ëª¨ë©˜í…€ ë¶„ì„ ìë™ ì‹¤í–‰

on:
  schedule:
    # ë§¤ì¼ í•œêµ­ì‹œê°„ ì˜¤ì „ 9ì‹œ (UTC 0ì‹œ)ì— ì‹¤í–‰
    - cron: '0 0 * * *'
  
  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:

env:
  PYTHONPATH: ${{ github.workspace }}
  TZ: Asia/Seoul

jobs:
  momentum-analysis:
    name: ëª¨ë©˜í…€ ë¶„ì„ ì‹¤í–‰
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
      uses: actions/checkout@v4
    
    - name: ğŸ Python í™˜ê²½ ì„¤ì •
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ğŸ“¦ ì˜ì¡´ì„± ìºì‹œ
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: ğŸ“š ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ğŸ” í™˜ê²½ í™•ì¸
      run: |
        echo "Python ë²„ì „: $(python --version)"
        echo "pip ë²„ì „: $(pip --version)"
        echo "í˜„ì¬ ì‹œê°„ (UTC): $(date -u)"
        echo "í˜„ì¬ ì‹œê°„ (KST): $(TZ=Asia/Seoul date)"
        echo "ì‘ì—… ë””ë ‰í† ë¦¬: $(pwd)"
        echo "íŒŒì¼ ëª©ë¡:"
        ls -la
        echo "ì„¤ì¹˜ëœ íŒ¨í‚¤ì§€:"
        pip list | grep -E "(yfinance|pandas|requests|numpy)"
    
    - name: ğŸ“Š ëª¨ë©˜í…€ ë¶„ì„ ì‹¤í–‰
      env:
        TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        CHAT_ID: ${{ secrets.CHAT_ID }}
      run: |
        python main.py
    
    - name: ğŸ“‹ ë¡œê·¸ íŒŒì¼ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: analysis-logs-${{ github.run_number }}
        path: |
          main.log
          momentum_analysis.log
          *.log
        retention-days: 7
        compression-level: 6
    
    - name: âœ… ì„±ê³µ ì•Œë¦¼
      if: success()
      env:
        TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        CHAT_ID: ${{ secrets.CHAT_ID }}
      run: |
        MESSAGE="âœ… ëª¨ë©˜í…€ ë¶„ì„ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œ
        
        ğŸ“Š ë¦¬í¬ì§€í† ë¦¬: ${{ github.repository }}
        ğŸ”— ì‹¤í–‰ ID: ${{ github.run_id }}
        ğŸ“… ì‹¤í–‰ ì‹œê°„: $(TZ=Asia/Seoul date '+%Y-%m-%d %H:%M:%S KST')
        â±ï¸ ì†Œìš” ì‹œê°„: ${{ github.event.workflow_run.duration || 'N/A' }}
        
        ìì„¸í•œ ê²°ê³¼ëŠ” ìœ„ì—ì„œ í™•ì¸í•˜ì„¸ìš”! ğŸ“ˆ"
        
        curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
          -d "chat_id=${CHAT_ID}" \
          -d "text=${MESSAGE}" \
          -d "parse_mode=HTML"
    
    - name: ğŸš¨ ì‹¤íŒ¨ ì•Œë¦¼
      if: failure()
      env:
        TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        CHAT_ID: ${{ secrets.CHAT_ID }}
      run: |
        MESSAGE="âŒ GitHub Actions ì‹¤í–‰ ì‹¤íŒ¨
        
        ğŸ“Š ë¦¬í¬ì§€í† ë¦¬: ${{ github.repository }}
        ğŸ”— ì‹¤í–‰ ID: ${{ github.run_id }}
        ğŸ“… ì‹¤íŒ¨ ì‹œê°„: $(TZ=Asia/Seoul date '+%Y-%m-%d %H:%M:%S KST')
        
        ğŸ” ë¡œê·¸ í™•ì¸: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
        
        ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ê±°ë‚˜ ë¡œê·¸ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”."
        
        curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
          -d "chat_id=${CHAT_ID}" \
          -d "text=${MESSAGE}" \
          -d "parse_mode=HTML"
